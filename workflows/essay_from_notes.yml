---
kind: workflow
id: essay_from_notes
version: 0.6
summary: "From a single markdown+frontmatter input, produce a coherent essay with analysis and citations; archive inputs alongside outputs."
input_schema:
  format: markdown+frontmatter
  required: [thesis, audience, stance, length_minutes]
  optional: [tone, sources[], deadline, keywords[], title, title_hint]
  note: "Frontmatter lives atop the same file as notes body."
io:
  input:
    key: essay.md
    expected_location: content/essays/in/
    schema: input_schema
  output:
    dir: content/essays/out/{{today}}/{{slug}}/
  archive:
    dir: content/essays/archive/{{today}}/{{slug}}/
inputs:
  - essay.md            # unified input with YAML frontmatter + notes body
  - context.refs[]?     # optional paths into /context and /content relevant to topic
agents:
  primary: ivy
  secondary: s_vektor
artifacts:
  - path: content/essays/out/{{today}}/{{slug}}/final.md
    format: markdown
  - path: content/essays/out/{{today}}/{{slug}}/final.pdf
    format: pdf
  - path: content/essays/out/{{today}}/{{slug}}/draft_checked.md
    format: markdown
    note: "Annotated draft after fact_check; preserved for audit."
  - path: content/essays/out/{{today}}/{{slug}}/outline.md
    format: markdown
  - path: content/essays/out/{{today}}/{{slug}}/draft.md
    format: markdown
  - path: content/essays/out/{{today}}/{{slug}}/refined.md
    format: markdown
  - path: content/essays/out/{{today}}/{{slug}}/citations.md
    format: markdown
  - path: content/essays/out/{{today}}/{{slug}}/claim_table.csv
    format: csv
  - path: content/essays/out/{{today}}/{{slug}}/edits.diff.md
    format: markdown
  - path: content/essays/archive/{{today}}/{{slug}}/input.md
    format: markdown
  - path: content/essays/archive/{{today}}/{{slug}}/intent.yml
    format: yaml
  - path: content/essays/archive/{{today}}/{{slug}}/notes.md
    format: markdown
provenance:
  include:
    - input_schema
    - agents
    - inputs
    - input_path
    - git_commit
    - time_started
    - time_finished
handoffs:
  - from: ivy
    to: s_vektor
    when: "Outline needs testable claims or ambiguous premises."
  - from: s_vektor
    to: ivy
    when: "Logical skeleton complete; ready for human-facing prose."
constraints:
  - "No invented citations. If a claim is not sourced, mark as assumption."
  - "Preserve author’s voice where specified; Ivy may tighten but not overwrite."
  - "If data are insufficient, return 'insufficient inputs' with a request list."
  - ">= 3 claims must be upgraded to (F) with resolving citations; otherwise return MISSING_FACTS."
  - "Opening hook must be concrete (image or micro-scene) within first 2 sentences."
  - "Money section includes a small worked numeric example; verify arithmetic."
  - "Practical Moves includes a tiny scene to humanize the checklist."
  - "Ending points forward (small, daily choice), not merely restating the thesis."
  - "Citations balanced: footnotes-first; at most one conversational in-text nod; avoid pamphlet tone."
  - "Relationships section must include a vivid image or micro-scene (the knot carried; boundary voiced)."
eval_checks:
  - "Does the thesis appear verbatim (or stronger) in the introduction and conclusion?"
  - "Are claims labeled fact/inference/unknown and supported or flagged?"
  - "Is structure visible (headings) and skimmable?"
  - "Do sources resolve and match in-text references?"
  - ">= 3 (F) claims with real, resolving citations present."
  - "Counterpoint section present (<= 3 sentences) distinguishing restorative comfort from avoidance."
  - "Opening hook uses concrete image(s) in the first 2 sentences."
  - "Practical Moves contains a tiny scene (2–4 sentences)."
  - "Ending points forward with a small, daily choice."
  - "Citation style: footnotes-first; in-text authority mentions <= 1."
  - "Relationships section contains a vivid image or micro-scene."
failure_modes:
  - code: MISSING_INTENT
    remedy: "Ask for thesis, audience, stance, and length_minutes."
  - code: THIN_EVIDENCE
    remedy: "List 3–5 discriminating questions or sources to acquire."
  - code: SCOPE_CREEP
    remedy: "Enforce length; move extras to 'Appendix / Next' section."
  - code: MISSING_FACTS
    remedy: ">= 3 claims must be upgraded to (F) with resolving citations; propose 3 primary or high‑quality secondary sources per target claim, or downgrade and return with request list."
  - code: NO_COUNTERPOINT
    remedy: "Insert a 2–3 sentence 'Counterpoint' section that distinguishes restorative comfort from avoidance; place after expansion and before fact check."
  - code: NO_HOOK
    remedy: "Add a concrete opening image or micro-scene within the first 2 sentences; prefer sensory detail over abstraction."
  - code: NO_SCENE
    remedy: "Add a 2–4 sentence tiny scene in 'Practical Moves' that shows the checklist lived (e.g., Sunday night audit)."
  - code: FLAT_ENDING
    remedy: "Revise the final paragraph to point forward with a small, daily choice rather than restating the thesis."
  - code: PAMPHLET_TONE
    remedy: "Move citations to footnotes; keep at most one conversational in-text nod; restore narrative voice."
  - code: NO_RELATIONSHIP_SCENE
    remedy: "Add a vivid image or micro-scene to the Relationships section (knot carried; boundary voiced)."
steps:
  - id: prepare_input
    actor: s_vektor
    description: "Parse frontmatter from essay.md; derive slug; emit derived inputs (intent.yml, notes.md); validate required fields."
    uses: procedures/prepare_essay_input.yml
    outputs: [intent.yml, notes.md, title.txt, slug.txt, meta.json]
  - id: collect
    actor: ivy
    description: "Digest notes and intent; extract candidate thesis and constraints."
    outputs: [draft_thesis, constraints.md, glossary.md]
  - id: outline
    actor: s_vektor
    description: "Produce a minimal outline with labeled claims (fact/inference/unknown)."
    outputs: [outline.md, claim_table.csv]
  - id: expand
    actor: ivy
    description: "Draft essay from outline; weave narrative and examples; add a concrete opening hook; maintain labels."
    outputs: [draft.md]
  - id: counterpoint
    actor: ivy
    description: "Insert a brief 'Counterpoint' section (2–3 sentences) distinguishing restorative comfort from avoidance; note how rest integrates change; ensure tone coherence."
    outputs: [counterpoint.md, draft.md]
  - id: check_citations
    actor: s_vektor
    description: "Verify references; upgrade >= 3 claims to (F) with resolving citations; ensure Money includes a small worked example; prefer footnotes and minimal in-text authority; add footnotes or mark assumptions; build bibliography."
    outputs: [draft_checked.md, citations.md]
  - id: refine_style
    actor: ivy
    description: "Tighten prose; vary cadence; weave citations naturally (footnotes-first); add tiny scenes (Practical Moves, Relationships); sharpen forward-looking ending; preserve labels and Counterpoint."
    outputs: [refined.md]
  - id: compile
    actor: s_vektor
    description: "Run eval_checks; emit final .md (with content-leaf frontmatter) and .pdf with provenance header."
    outputs: [final.md, final.pdf]
  - id: archive_input
    actor: s_vektor
    description: "Move original essay.md into archive dir under content/essays/archive/{{today}}/{{slug}}/input.md; store derived intent.yml and notes.md; remove the original from content/essays/in/."
    outputs: [archive/input.md, archive/intent.yml, archive/notes.md]
postamble:
  next_actions:
    - "Propose two spin-off pieces (short post + long-form)."
    - "Update /content/roots or /content/leaves with canonical excerpt."
    - "Register sources in /context/sources.yml if new."
---
# Runner Guidance (human/agent)

1) **Provide a single input** at `content/essays/in/<your-file>.md` with YAML frontmatter containing: `thesis, audience, stance, length_minutes` (plus optional `tone, sources[], deadline, keywords[], title|title_hint`). Place your rough notes in the body below the frontmatter.
2) **Call**: `cora run --workflow essay_from_notes --in content/essays/in/<your-file>.md`  
3) **Collect artifacts** in `content/essays/out/YYYY-MM-DD/<slug>/` including provenance and eval report. The original input and derived files are archived under `content/essays/archive/YYYY-MM-DD/<slug>/` (input.md, intent.yml, notes.md). The input is removed from `content/essays/in/` after archival.
